# runs vulnerability scans and add them to Github Security tab

name: OSV-Scanner Scan

on:
  workflow_dispatch:
  schedule:
  - cron: "24 6 * * *"
  pull_request:
    paths:
    - '.github/workflows/osv-scanner-scan.yml'

permissions: {}

jobs:
  scan-scheduled:
    permissions:
      actions: read
      contents: read
      security-events: write # for uploading SARIF files
    if: ${{ github.repository == 'metal3-io/baremetal-operator' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
    - name: Calculate go version
      id: vars
      run: echo "go_version=$(make go-version)" >> "${GITHUB_OUTPUT}"
    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        go-version: ${{ steps.vars.outputs.go_version }}
    # NOTE: this "go install" is not updated by Dependabot
    - name: Install OSV Scanner
      run: go install github.com/google/osv-scanner/v2/cmd/osv-scanner@a14aa98ab8408547083d4411091c5fbaf5b47d8e # v2.2.0
    - name: Run OSV Scanner
      id: osv-scan
      run: |
        # osv-scanner returns 1 if there is vulnerability, but script runs with set -e by default
        # disable it, so we can set the has_vulnerabilities variable for slack reporter
        osv-scanner scan \
          --format json --output results.json --recursive \
          --config=<( echo "GoVersionOverride = \"${{ steps.vars.outputs.go_version }}\"" ) \
          ./ || true
        echo "has_vulnerabilities=$(jq '.results | length > 0' results.json)" >> "${GITHUB_OUTPUT}"
      continue-on-error: true
    - name: "Run OSV Scanner Reporter"
      uses: google/osv-scanner/actions/reporter@16ed4529c0d0cc1ddf1bed2fb08deba187339673 # v2.2.2
      with:
        scan-args: |-
          --output=results.sarif
          --new=results.json
          --gh-annotations=false
      continue-on-error: true
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@192325c86100d080feab897ff886c34abd4c83a3 # v3.29.5
      with:
        sarif_file: results.sarif
      continue-on-error: true
    # Send notification if vulnerabilities found or any step failed
    - name: Slack Notification on Vulnerability or Failure
      if: ${{ steps.osv-scan.outputs.has_vulnerabilities == 'true' || failure() }}
      uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # 2.3.3
      env:
        SLACK_TITLE: "OSV-Scanner failed or detected vulnerabilities in ${{ github.repository }}"
        SLACK_COLOR: "#FF0000"
        SLACK_MESSAGE: "OSV-Scanner failed or detected vulnerabilities in ${{ github.repository }}"
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: metal3-github-actions-notify
        SLACK_USERNAME: metal3-github-actions-notify
